#!/usr/bin/env ruby

require 'war_room'
require 'gli'
require 'tty-table'

include GLI::App

program_desc 'A collection of tools for table-top RPG game-masters.'

version WarRoom::VERSION

pre do |global_options, command, options, args|
  # Nothing yet..
  true
end

desc 'Tools for working with roll-tables'
command :table do |c|
  c.desc 'Generate a roll-table'
  c.arg :data_file
  c.command :generate do |c|
    c.desc 'Die type to generate table for'
    c.flag [:d, :die], type: String, default_value: 'd4,d6,d8,d10,d12,d20', must_match: /d[0-9]+(,d[0-9]+)*/

    c.desc 'Always include all rows'
    c.switch 'include-all', default_value: true

    c.action do |global_options, options, args|
      input_file = args.first
      help_now! 'Input data-file not specified' unless input_file

      data = WarRoom::DieTable::Generator.load_yaml(args.first)
      opts = {
          include_all: options['include-all']
      }
      die_table = WarRoom::DieTable::Generator.generate(options[:die].split(','), data, **opts)
      if die_table
        filter = lambda do |range|
          if range.begin != range.end
            "#{range.begin}â€“#{range.end}"
          else
            range.begin
          end
        end
        rows = die_table.rows.map(&:to_a)
        rows.map! { |row| [filter[row[0]], row[1]] }

        table = TTY::Table.new(header: [die_table.die, 'Result'], rows: rows)
        puts table.render(:unicode, padding: [0, 1])
      else
        puts 'Unable to generate table for the given die/dice'
      end
    end
  end
end

exit run(ARGV)
